<script>
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state'); // 这里存的是当初点击登录的页面地址

    if (code) {
        // 1. 去 Worker 换 Token
        fetch(`https://openstsubmission.linvin.net/api/exchange-token?code=${code}`)
            .then(res => res.json())
            .then(data => {
                if (data.access_token) {
                    // 2. 存入全站通用的 localStorage
                    localStorage.setItem('gh_auth', JSON.stringify({
                        token: data.access_token,
                        timestamp: new Date().getTime()
                    }));
                    // 3. 根据 state 完美回源
                    window.location.href = state ? atob(state) : './archive.html';
                }
            });
    }
</script>