<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Edit Wiki - OpenST</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown-dark.css">

    <style>
        :root { --brand-color: #40B5AD; --bg-deep: #0c0c0c; }
        body { background-color: var(--bg-deep); color: #e0e0e0; font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }

        .glass-panel { background: rgba(255, 255, 255, 0.01); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 24px; }
        .cyber-btn { background: var(--brand-color); color: #000; font-weight: 800; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .cyber-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 0 20px rgba(64, 181, 173, 0.4); }

        /* È¢ÑËßàÂå∫ÂÆöÂà∂ */
        .markdown-body { background: transparent !important; font-size: 14px; line-height: 1.8; color: rgba(255,255,255,0.8); }
        .markdown-body h1, .markdown-body h2 { border-bottom-color: rgba(255,255,255,0.1); }

        /* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .no-scrollbar::-webkit-scrollbar { width: 4px; }
        .no-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 10px; }

        /* Â∑¶Âè≥ÂàÜÂâ≤Á∫ø */
        .resizer { width: 1px; background: rgba(255,255,255,0.05); margin: 0 4px; }
    </style>
</head>
<body>

<div id="editor-app" class="h-screen w-full flex flex-col p-4 lg:p-6 fade-in">

    <header class="flex justify-between items-center mb-4 px-4">
        <div class="flex items-center gap-4">
            <a href="wiki.html" class="text-[10px] font-black tracking-[0.3em] text-white/20 hover:text-[#40B5AD] transition-all uppercase">Exit</a>
            <div class="h-4 w-px bg-white/10"></div>
            <h1 class="text-sm font-mono tracking-tighter text-white/60">
                editing: <span class="text-[#40B5AD]">{{ filePath }}</span>
            </h1>
        </div>

        <div class="flex items-center gap-4">
            <span v-if="loading" class="text-[10px] text-white/20 animate-pulse tracking-widest uppercase">Syncing...</span>
            <button @click="submitEdit" :disabled="loading || !content.trim()" class="cyber-btn px-6 py-2 rounded-lg text-[11px]">
                {{ loading ? 'WAIT' : 'COMMIT' }}
            </button>
        </div>
    </header>

    <main class="flex-1 flex glass-panel overflow-hidden">
        <section class="flex-1 flex flex-col min-w-0">
            <div class="px-6 py-2 border-bottom border-white/5 text-[9px] text-white/20 font-mono tracking-widest uppercase flex justify-between">
                <span>Editor / Markdown</span>
                <span>{{ content.length }} chars</span>
            </div>
            <textarea
                    v-model="content"
                    spellcheck="false"
                    class="flex-1 w-full p-8 lg:p-10 bg-transparent outline-none font-mono text-sm leading-relaxed text-white/70 resize-none no-scrollbar">
            </textarea>
        </section>

        <div class="resizer"></div>

        <section class="flex-1 flex flex-col min-w-0 bg-white/[0.005]">
            <div class="px-6 py-2 border-bottom border-white/5 text-[9px] text-[#40B5AD] font-mono tracking-widest uppercase">
                Live Preview
            </div>
            <div
                    v-html="previewHtml"
                    class="markdown-body flex-1 w-full p-8 lg:p-10 overflow-y-auto no-scrollbar">
            </div>
        </section>
    </main>

    <footer v-if="user" class="mt-3 px-4 flex justify-end">
        <div class="text-[9px] font-mono text-white/10 tracking-[0.2em]">
            IDENTIFIED AS: <span class="text-white/40">{{ user.login.toUpperCase() }}</span>
        </div>
    </footer>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                filePath: new URLSearchParams(window.location.search).get('path') || '/README',
                content: '',
                loading: false,
                user: null
            }
        },
        computed: {
            previewHtml() {
                // Â∞Ü Markdown ËΩ¨Êç¢‰∏∫ HTML
                return marked.parse(this.content || '*Nothing to preview...*');
            }
        },
        async mounted() {
            this.checkAuth();
            const normalizedPath = this.filePath.startsWith('/') ? this.filePath : '/' + this.filePath;
            try {
                const res = await fetch(`./content${normalizedPath}.md`);
                this.content = res.ok ? await res.text() : "# File Not Found\nStarting a new document...";
            } catch (e) {
                this.content = "# Error\nCould not fetch remote content.";
            }
        },
        methods: {
            checkAuth() {
                const raw = localStorage.getItem('gh_auth');
                if (!raw) { window.location.href = 'wiki.html'; return; }
                this.user = JSON.parse(raw);
            },
            async submitEdit() {
                this.loading = true;
                try {
                    const res = await fetch(`https://api.github.com/repos/MC-OpenST/Submissions/issues`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${this.user.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            title: `[Wiki‰øÆËÆ¢] ${this.filePath}`,
                            body: `### üõ†Ô∏è Wiki ‰øÆËÆ¢Êèê‰∫§\n\n- **Ë∑ØÂæÑ**: \`content${this.filePath}.md\`\n- **‰ΩúËÄÖ**: @${this.user.login}\n\n#### ‰øÆËÆ¢ÂÜÖÂÆπ:\n\n\`\`\`markdown\n${this.content}\n\`\`\``
                        })
                    });
                    if (res.ok) { alert('Submitted!'); window.location.href = 'wiki.html'; }
                } catch (e) { alert('Error: ' + e.message); }
                finally { this.loading = false; }
            }
        }
    }).mount('#editor-app');
</script>

</body>
</html>