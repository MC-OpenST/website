<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>OpenST Wiki Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --brand-color: #40B5AD;
            --bg-deep: #0c0c0c;
        }

        body {
            background-color: var(--bg-deep);
            color: #e0e0e0;
            font-family: 'Inter', system-ui, sans-serif;
            overflow: hidden;
        }

        /* ç£¨ç ‚ç»ç’ƒè´¨æ„Ÿ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 40px;
        }

        /* èµ›åšæŒ‰é’® */
        .cyber-btn {
            background: var(--brand-color);
            color: #000;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 4px 20px rgba(64, 181, 173, 0.2);
        }

        .cyber-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(64, 181, 173, 0.4);
            filter: brightness(1.1);
        }

        .cyber-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ç¼–è¾‘å™¨æ–‡æœ¬åŸŸè‡ªå®šä¹‰ */
        textarea {
            caret-color: var(--brand-color);
            line-height: 2.2;
        }

        textarea::-webkit-scrollbar {
            width: 4px;
        }

        textarea::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        /* åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div id="editor-app" class="h-screen w-full flex flex-col p-6 lg:p-10 fade-in">

    <header class="flex justify-between items-end mb-8 px-4">
        <div class="space-y-3">
            <div class="flex items-center gap-3 text-[10px] font-black tracking-[0.3em] text-white/20">
                <a href="wiki.html" class="hover:text-[#40B5AD] transition-all">EXIT_WIKI</a>
                <span>/</span>
                <span class="text-white/60">REVISION_CORE_V4</span>
            </div>
            <h1 class="text-xl lg:text-2xl font-light tracking-tight flex items-center gap-2">
                <span class="text-white/10 font-mono">content/</span>
                <span class="text-white/90">{{ filePath }}</span>
                <span class="text-[#40B5AD]">.md</span>
            </h1>
        </div>

        <div class="flex items-center gap-6">
            <div v-if="user" class="hidden md:flex flex-col items-end leading-none">
                <span class="text-white/40 text-[10px] font-mono mb-1 uppercase tracking-widest">Operator</span>
                <span class="text-white text-xs font-bold">{{ user.login }}</span>
            </div>
            <button @click="submitEdit" :disabled="loading || !content.trim()" class="cyber-btn px-8 py-3 rounded-xl text-xs">
                {{ loading ? 'Pushing Data...' : 'Commit Changes' }}
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col glass-panel relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#40B5AD]/20 to-transparent"></div>

        <textarea
                v-model="content"
                spellcheck="false"
                placeholder="// Loading content or waiting for input..."
                class="flex-1 w-full p-8 lg:p-14 bg-transparent outline-none font-mono text-sm lg:text-base text-white/70 resize-none overflow-y-auto">
        </textarea>

        <footer class="h-10 border-t border-white/5 flex items-center justify-between px-8 bg-black/20">
            <div class="flex gap-6 items-center text-[9px] font-mono text-white/20 tracking-widest uppercase">
                <span class="flex items-center gap-1.5">
                    <span class="w-1 h-1 rounded-full bg-[#40B5AD]"></span>
                    {{ content.length }} chars
                </span>
                <span class="flex items-center gap-1.5">
                    <span class="w-1 h-1 rounded-full bg-white/20"></span>
                    {{ content.split('\n').length }} lines
                </span>
            </div>
            <div class="text-[9px] font-mono text-white/10 tracking-[0.2em] uppercase">
                OpenST Archive System v4.0.2
            </div>
        </footer>
    </main>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                filePath: new URLSearchParams(window.location.search).get('path') || '/README',
                content: '',
                loading: false,
                user: null
            }
        },
        async mounted() {
            // 1. è·å–ç™»å½•ä¿¡æ¯
            this.checkAuth();

            // 2. æ ¼å¼åŒ–è·¯å¾„å¹¶è·å–æºç 
            const normalizedPath = this.filePath.startsWith('/') ? this.filePath : '/' + this.filePath;
            try {
                // è‡ªåŠ¨è¯†åˆ«ç›®å½•å±‚çº§
                const res = await fetch(`./content${normalizedPath}.md`);
                if (!res.ok) throw new Error('File not found');
                this.content = await res.text();
            } catch (e) {
                console.warn("Path fetch failed, switching to fallback.");
                this.content = "# New Page\n\nEdit your content here...";
            }
        },
        methods: {
            checkAuth() {
                const raw = localStorage.getItem('gh_auth');
                if (!raw) {
                    alert("Unauthorized access. Please login via Wiki home.");
                    window.location.href = 'wiki.html';
                    return;
                }
                this.user = JSON.parse(raw);
            },
            async submitEdit() {
                if (this.loading) return;

                this.loading = true;
                try {
                    const res = await fetch(`https://api.github.com/repos/MC-OpenST/Submissions/issues`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${this.user.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            title: `[Wikiä¿®è®¢] ${this.filePath}`,
                            body: `### ğŸ› ï¸ Wiki å†…å®¹ä¿®è®¢ç”³è¯·\n\n- **ç›®æ ‡è·¯å¾„**: \`content${this.filePath}.md\`\n- **è´¡çŒ®è€…**: @${this.user.login}\n\n#### ä¿®è®¢åçš„ Markdown å†…å®¹:\n\n\`\`\`markdown\n${this.content}\n\`\`\`\n\n--- \n*Generated by OpenST Unified Editor*`
                        })
                    });

                    if (res.ok) {
                        alert('Submission Successful! Redirecting to Wiki...');
                        window.location.href = 'wiki.html';
                    } else {
                        const err = await res.json();
                        throw new Error(err.message || 'API Error');
                    }
                } catch (e) {
                    alert('Submission Error: ' + e.message);
                } finally {
                    this.loading = false;
                }
            }
        }
    }).mount('#editor-app');
</script>

</body>
</html>