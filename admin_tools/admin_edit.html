<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenST 稿件编辑器 (for staff)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* 1. 防止闪烁 */
        [v-cloak] { display: none; }

        /* 2. 品牌色与滚动条 */
        :root { --brand: #40B5AD; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(64, 181, 173, 0.2); border-radius: 10px; transition: 0.3s; }
        ::-webkit-scrollbar-thumb:hover { background: var(--brand); }

        body {
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            overflow-y: auto;
            padding-bottom: 5rem;
        }

        /* 3. Markdown 渲染美化 */
        .markdown-body { line-height: 1.6; color: #ccc; overflow-wrap: break-word; }
        .markdown-body h1 { font-size: 1.5rem; color: #fff; border-bottom: 2px solid var(--brand); padding-bottom: 0.3rem; margin: 1.5rem 0 1rem; }
        .markdown-body h2 { font-size: 1.25rem; border-left: 4px solid var(--brand); padding-left: 0.75rem; margin: 1.2rem 0 0.8rem; }
        .markdown-body h3 { font-size: 1.1rem; color: var(--brand); margin: 1rem 0 0.5rem; font-weight: bold; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin: 1rem 0; }
        .markdown-body blockquote { border-left: 4px solid #2a6a65; padding-left: 1rem; color: #888; background: rgba(64,181,173,0.05); padding: 8px 16px; border-radius: 0 8px 8px 0; }
        .markdown-body code { background: rgba(64,181,173,0.15); color: var(--brand); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; }
        .markdown-body pre { overflow-x: auto; background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 0.75rem; }
        .markdown-body img { border-radius: 0.5rem; max-width: 100%; }
        .markdown-body a { color: var(--brand); text-decoration: underline; text-underline-offset: 4px; }
    </style>
</head>
<body class="p-6 md:p-12">
<div id="app" v-cloak class="max-w-[1400px] mx-auto">
    <header class="flex justify-between items-end mb-10 border-b border-white/5 pb-6">
        <div>
            <h1 class="text-3xl font-bold text-[--brand] tracking-tight">OpenST Editor</h1>
            <p class="text-white/30 text-sm mt-2 font-mono">Archive: {{ editForm.id }}</p>
        </div>
        <div class="flex gap-4">
            <a href="../archive.html" class="px-5 py-2.5 rounded-xl bg-white/5 hover:bg-white/10 transition-all text-sm border border-white/10">放弃返回</a>
            <button @click="submitSave" :disabled="isSaving"
                    class="px-8 py-2.5 rounded-xl bg-[--brand] text-black font-extrabold hover:scale-105 active:scale-95 transition-all shadow-lg shadow-[#40B5AD]/20 disabled:opacity-50">
                {{ isSaving ? '同步中...' : '提交修改' }}
            </button>
        </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-start">

        <div class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-white/40 ml-1 uppercase tracking-widest">作品名称</label>
                    <input v-model="editForm.name" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:border-[--brand] outline-none transition-all text-lg">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-white/40 ml-1 uppercase tracking-widest">作者</label>
                    <input v-model="editForm.author" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:border-[--brand] outline-none transition-all text-lg">
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-xs font-bold text-white/40 ml-1 uppercase tracking-widest">标签分类 (二级/三级均可点选)</label>
                <div class="bg-white/5 p-6 rounded-3xl border border-white/10 space-y-8">

                    <div v-for="(subConfig, mainCat) in TAG_CONFIG" :key="mainCat" class="border-l-2 border-white/10 pl-4">
                        <h3 class="text-sm font-bold text-[--brand] mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-[--brand]"></span>
                            {{ mainCat }}
                        </h3>

                        <div v-if="!Array.isArray(subConfig)" class="space-y-5">
                            <div v-for="(tags, subCat) in subConfig" :key="subCat">

                                <div class="mb-2 flex items-center gap-2">
                                    <button @click="toggleTag(subCat)"
                                            :class="editForm.tags.includes(subCat) ? 'text-[--brand] border-[--brand] bg-[--brand]/10' : 'text-white/30 border-transparent hover:text-white/60'"
                                            class="text-[10px] font-mono uppercase tracking-tighter px-2 py-0.5 border rounded transition-all">
                                        {{ subCat }}
                                    </button>
                                    <span v-if="tags.length === 0" class="text-[9px] text-white/10 font-mono italic">EMPTY SLOT</span>
                                </div>

                                <div class="flex flex-wrap gap-2 ml-2">
                                    <button v-for="tag in tags" :key="tag" @click="toggleTag(tag)"
                                            :class="editForm.tags.includes(tag) ? 'bg-[--brand] text-black border-[--brand]' : 'bg-white/5 text-white/40 border-white/10 hover:border-white/30'"
                                            class="px-2.5 py-1 rounded-lg text-[11px] transition-all border">
                                        {{ tag }}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div v-else class="flex flex-wrap gap-2">
                            <button v-for="tag in subConfig" :key="tag" @click="toggleTag(tag)"
                                    :class="editForm.tags.includes(tag) ? 'bg-[--brand] text-black border-[--brand]' : 'bg-white/5 text-white/40 border-white/10 hover:border-white/30'"
                                    class="px-2.5 py-1 rounded-lg text-[11px] transition-all border">
                                {{ tag }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-xs font-bold text-white/40 ml-1 uppercase tracking-widest">Markdown 内容</label>
                <textarea v-model="editForm.description"
                          class="w-full min-h-[600px] bg-white/5 border border-white/10 p-6 rounded-3xl font-mono text-base outline-none focus:border-[--brand] transition-all resize-none"
                          placeholder="输入内容..."></textarea>
            </div>
        </div>

        <div class="sticky top-6"> <div class="bg-white/5 border border-white/10 rounded-3xl overflow-hidden shadow-2xl">
            <div class="px-6 py-4 bg-white/5 border-b border-white/5 flex justify-between items-center">
                <span class="text-xs font-bold text-white/20 uppercase tracking-[0.2em]">Live Preview</span>
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500/20"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500/20"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500/20"></div>
                </div>
            </div>
            <div class="p-8 md:p-10 markdown-body min-h-[400px]">
                <h1 class="!mt-0 !pt-0">{{ editForm.name || 'Untitled' }}</h1>
                <div v-html="previewHtml"></div>
            </div>
        </div>
        </div>
    </main>
</div>

<script type="module">
    import { TAG_CONFIG } from '../scripts/config.js';
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isSaving: false,
                TAG_CONFIG,
                editForm: { id: '', name: '', author: '', tags: [], description: '', preview: '', filename: '' },
                WORKER_URL: 'https://openstsubmission.linvin.net'
            }
        },
        computed: {
            previewHtml() {
                marked.setOptions({ breaks: true, gfm: true });
                return marked.parse(this.editForm.description || '_等待输入内容..._');
            }
        },
        async mounted() {
            const folder = new URLSearchParams(window.location.search).get('folder');
            if (!folder) return;
            try {
                const res = await fetch('../data/database.json');
                const database = await res.json();
                const item = database.find(i => i.id === folder);
                if (item) this.editForm = JSON.parse(JSON.stringify(item));
            } catch (e) { console.error("Load failed", e); }
        },
        methods: {
            toggleTag(tag) {
                const idx = this.editForm.tags.indexOf(tag);
                idx > -1 ? this.editForm.tags.splice(idx, 1) : this.editForm.tags.push(tag);
            },
            async submitSave() {
                if (this.isSaving) return;

                // 严格按照 PortalAuth 的格式读取
                const raw = localStorage.getItem('gh_auth');
                const auth = raw ? JSON.parse(raw) : null;

                const token = auth?.token;

                if (!token) {
                    console.error("[Auth] No valid session found in gh_auth");
                    alert("❌ 认证失效：请返回主页重新登录 w");
                    return;
                }

                this.isSaving = true;

                // 准备提交数据
                const cleanData = JSON.parse(JSON.stringify(this.editForm));
                const stripPath = (s) => (s && typeof s === 'string' && s.includes('/')) ? s.split('/').pop() : s;

                cleanData.preview = stripPath(cleanData.preview);
                cleanData.filename = stripPath(cleanData.filename);

                try {
                    const res = await fetch(`${this.WORKER_URL}/api/admin/update-info`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` // 发送 access_token
                        },
                        body: JSON.stringify({
                            folder: cleanData.id,
                            newInfo: cleanData
                        })
                    });

                    if (res.ok) {
                        alert("✅ 修改成功！");
                        window.location.href = '../archive.html';
                    } else {
                        const err = await res.json();
                        alert("❌ 提交失败: " + (err.error || "Worker 拒绝了请求"));
                    }
                } catch (e) {
                    alert("❌ 网络错误: " + e.message);
                } finally {
                    this.isSaving = false;
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>